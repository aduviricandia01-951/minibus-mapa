<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ubicaci贸n en tiempo real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    #direccion {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="direccion">Direcci贸n: Esperando ubicaci贸n del minib煤s...</div>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([-16.55, -68.17], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '漏 OpenStreetMap contributors'
    }).addTo(map);

    let userLocation;
    const direccionPanel = document.getElementById("direccion");

    const minibusIcon = L.icon({
      iconUrl: 'minibus.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    const paradaIcon = L.icon({
      iconUrl: 'parada.png',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -30]
    });

    const marker = L.marker([-16.55, -68.17], { icon: minibusIcon }).addTo(map);

    const rutaIda = [
      [-16.61532802179032, -68.17491486686562],
      [-16.607728340287515, -68.17505139695902],
      [-16.608023955472067, -68.18318918944819],
      [-16.571950684195162, -68.18574320411543],
      [-16.569936700121115, -68.18576042898955],
      [-16.568133387993406, -68.18519903299479],
      [-16.56621392030757, -68.18441571967614],
      [-16.55782239588086, -68.18086526913896],
      [-16.50738057307611, -68.16379390618263]
    ];

    const rutaVuelta = [...rutaIda].reverse();
    
    const rutaEstatica = L.polyline(rutaIda, {
      color: 'blue',
      weight: 8,
      opacity: 0.6
    }).addTo(map);


    //PARADAS
    const paradas = [
      { nombre: " Parada 739", coords: [-16.61532802179032, -68.17491486686562] },
      { nombre: " Parada 14", coords: [-16.607866389744196, -68.17513534198416] },
      { nombre: " Cruce 14", coords: [-16.6079874264066, -68.18318282254427] },
      { nombre: " Villaz贸n", coords: [-16.604372781077153, -68.18351075498687] },
      { nombre: " Puente Vela", coords: [-16.598425064729458, -68.1839390435208] },
      { nombre: " Chijimarka", coords: [-16.59000982849341, -68.18452013033361] },
      { nombre: " Extranka-Senkata", coords: [-16.58252202640734, -68.18506890203011] },
      { nombre: " YPFB", coords: [-16.570454069234277, -68.18585612516785] },
      { nombre: " Zona Franca", coords: [-16.554434374284217, -68.17971994339607] },
      { nombre: " Puente Bolivia", coords: [-16.54590086706111, -68.1768605941535] },
      { nombre: " Telef茅fico Morado", coords: [-16.5233101297636, -68.16911465015127] },
      { nombre: " Cruce Viacha", coords: [-16.516567680369718, -68.16686350385443] },
      { nombre: " Ceja Calle 3", coords: [-16.507482489025175, -68.16380745175105] },
    ];

    paradas.forEach(parada => {
      L.marker(parada.coords, { icon: paradaIcon })
        .addTo(map)
        .bindPopup(parada.nombre);
    });

    function encontrarParadaMasCercana(userLatLng) {
      let paradaCercana = null;
      let distanciaMinima = Infinity;

      paradas.forEach(parada => {
        const paradaLatLng = L.latLng(parada.coords[0], parada.coords[1]);
        const distancia = userLatLng.distanceTo(paradaLatLng);

        if (distancia < distanciaMinima) {
          distanciaMinima = distancia;
          paradaCercana = parada;
        }
      });

      return paradaCercana;
    }

    function calcularDistanciaMetros(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return Math.round(R * c);
    }

    function mostrarETA(origen, destino, mensaje = " Tiempo estimado") {
      fetch(`https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=false`)
        .then(res => res.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            const duration = data.routes[0].duration;
            const minutos = Math.round(duration / 60);
            const distancia = calcularDistanciaMetros(origen.lat, origen.lng, destino.lat, destino.lng);
            L.popup()
              .setLatLng(destino)
              .setContent(`${mensaje}: ${minutos} min<br> Distancia: ${distancia} metros`)
              .openOn(map);
          }
        });
    }

    navigator.geolocation.getCurrentPosition(position => {
      userLocation = [position.coords.latitude, position.coords.longitude];
      const userLatLng = L.latLng(userLocation[0], userLocation[1]);

      L.marker(userLocation).addTo(map).bindPopup("Tu ubicaci贸n").openPopup();

      const paradaCercana = encontrarParadaMasCercana(userLatLng);
      if (paradaCercana) {
        const origen = marker.getLatLng();
        const destino = L.latLng(paradaCercana.coords[0], paradaCercana.coords[1]);
        mostrarETA(origen, destino, `Л ETA a ${paradaCercana.nombre}`);
      }
    }, error => {
      console.warn("No se pudo obtener la ubicaci贸n del usuario.");
      direccionPanel.textContent = "Ubicaci贸n del usuario no disponible.";
    });

    let previousPosition = null;
    let rutaIdaPolyline = null;
    let rutaVueltaPolyline = null;

    function estaSobreRuta(latlng, polyline, toleranciaMetros = 30) {
      const punto = L.latLng(latlng.lat, latlng.lng);
      const closest = L.GeometryUtil.closest(map, polyline, punto);
      const distancia = punto.distanceTo(closest);
      return distancia <= toleranciaMetros;
    }

    const client = mqtt.connect('wss://8d698bb1bcec446a98ecbb56b2c2fb8e.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'minibus1',
      password: 'Gatomon951*',
      protocol: 'wss',
      rejectUnauthorized: false
    });

    client.on('connect', () => {
      console.log('Conectado a HiveMQ');
      client.subscribe('owntracks/minibus1/bus01');
    });
    client.on('message', (topic, message) => {
  try {
    const data = JSON.parse(message.toString());
    if (data._type === 'location' && data.lat && data.lon) {
      const lat = data.lat;
      const lon = data.lon;

      marker.setLatLng([lat, lon]);
      map.flyTo([lat, lon], 15);

      if (previousPosition) {
        const deltaLat = lat - previousPosition[0];
        const direction = deltaLat < 0 ? 'sur' : 'norte';

        if (rutaIdaPolyline) map.removeLayer(rutaIdaPolyline);
        if (rutaVueltaPolyline) map.removeLayer(rutaVueltaPolyline);

        if (direction === 'sur') {
          rutaIdaPolyline = L.polyline(rutaIda, {
            color: 'red',
            weight: 6,
            opacity: 0.9
          }).addTo(map);
          direccionPanel.textContent = "Direcci贸n: Hacia La Ceja";
        } else {
          rutaVueltaPolyline = L.polyline(rutaVuelta, {
            color: 'green',
            weight: 6,
            opacity: 0.9
          }).addTo(map);
          direccionPanel.textContent = "Direcci贸n: Hacia Parada 14";
        }

        if (userLocation) {
          const userLatLng = L.latLng(userLocation[0], userLocation[1]);
          const paradaCercana = encontrarParadaMasCercana(userLatLng);
          if (paradaCercana) {
            const destino = L.latLng(paradaCercana.coords[0], paradaCercana.coords[1]);
            const origen = L.latLng(lat, lon);
            mostrarETA(origen, destino, `Л ETA a ${paradaCercana.nombre}`);
          }
        }
      }

      previousPosition = [lat, lon];
      console.log(`Ubicaci贸n actualizada: ${lat}, ${lon}`);
    }
  } catch (err) {
    console.error('Error al procesar el mensaje MQTT:', err);
  }
});
  </script>
</body>
</html>
