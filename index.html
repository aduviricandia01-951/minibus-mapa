<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ubicaci√≥n en tiempo real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    #direccion {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="direccion">Direcci√≥n: Detectando...</div>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([-16.55, -68.17], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let userLocation;
    navigator.geolocation.getCurrentPosition(position => {
      userLocation = [position.coords.latitude, position.coords.longitude];
      L.marker(userLocation).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
    });

    const minibusIcon = L.icon({
      iconUrl: 'minibus.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    const marker = L.marker([-16.55, -68.17], { icon: minibusIcon }).addTo(map);

    const rutaIda = [
      [-16.607728340287515, -68.17505139695902],
      [-16.608023955472067, -68.18318918944819],
      [-16.571950684195162, -68.18574320411543],
      [-16.569936700121115, -68.18576042898955],
      [-16.568133387993406, -68.18519903299479],
      [-16.56621392030757, -68.18441571967614],
      [-16.55782239588086, -68.18086526913896],
      [-16.50738057307611, -68.16379390618263],
      [-16.50738057307611, -68.16379390618263],
      [-16.50738057307611, -68.16379390618263]
    ];

    const rutaVuelta = [...rutaIda].reverse();

    // Ruta amarilla est√°tica
    const rutaAmarilla = L.polyline(rutaIda, {
      color: 'yellow',
      weight: 4,
      opacity: 0.5
    }).addTo(map);

    let previousPosition = null;
    let rutaIdaPolyline = null;
    let rutaVueltaPolyline = null;

    const direccionPanel = document.getElementById("direccion");

    function estaSobreRuta(latlng, ruta, toleranciaMetros = 30) {
      const toleranciaGrados = toleranciaMetros / 111320;
      return ruta.some(punto => {
        const distancia = Math.sqrt(
          Math.pow(latlng.lat - punto[0], 2) + Math.pow(latlng.lng - punto[1], 2)
        );
        return distancia <= toleranciaGrados;
      });
    }

    function calcularDistanciaMetros(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return Math.round(R * c);
    }

    function mostrarETA(origen, destino, mensaje = "üïí Tiempo estimado") {
      fetch(`https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=false`)
        .then(res => res.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            const duration = data.routes[0].duration;
            const minutos = Math.round(duration / 60);
            const distancia = calcularDistanciaMetros(origen.lat, origen.lng, destino.lat, destino.lng);
            L.popup()
              .setLatLng(destino)
              .setContent(`${mensaje}: ${minutos} min<br>üìè Distancia: ${distancia} metros`)
              .openOn(map);
          }
        });
    }

    map.on('click', function(e) {
      const destino = e.latlng;
      const origen = marker.getLatLng();
      if (!origen) return;

      const sobreRutaIda = estaSobreRuta(destino, rutaIda);
      const sobreRutaVuelta = estaSobreRuta(destino, rutaVuelta);

      if (!sobreRutaIda && !sobreRutaVuelta) {
        L.popup()
          .setLatLng(destino)
          .setContent("‚ùå Este punto no est√° sobre la ruta oficial del minib√∫s.")
          .openOn(map);
        return;
      }

      mostrarETA(origen, destino);
    });

    const client = mqtt.connect('wss://8d698bb1bcec446a98ecbb56b2c2fb8e.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'minibus1',
      password: 'Gatomon951*',
      protocol: 'wss',
      rejectUnauthorized: false
    });

    client.on('connect', () => {
      console.log('Conectado a HiveMQ');
      client.subscribe('owntracks/minibus1/bus01');
    });

    client.on('message', (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        if (data._type === 'location' && data.lat && data.lon) {
          const lat = data.lat;
          const lon = data.lon;

          marker.setLatLng([lat, lon]);
          map.flyTo([lat, lon], 15);

          if (previousPosition) {
            const deltaLat = lat - previousPosition[0];
            const direction = deltaLat < 0 ? 'sur' : 'norte';

            if (rutaIdaPolyline) map.removeLayer(rutaIdaPolyline);
            if (rutaVueltaPolyline) map.removeLayer(rutaVueltaPolyline);

            if (direction === 'sur') {
              rutaIdaPolyline = L.polyline(rutaIda, {
                color: 'red',
                weight: 6,
                opacity: 0.9
              }).addTo(map);
              direccionPanel.textContent = "Direcci√≥n: Hacia La Ceja";
            } else {
              rutaVueltaPolyline = L.polyline(rutaVuelta, {
                color: 'green',
                weight: 6,
                opacity: 0.9
              }).addTo(map);
              direccionPanel.textContent = "Direcci√≥n: Hacia Parada 14";
            }

            if (userLocation) {
              const userLatLng = L.latLng(userLocation[0], userLocation[1]);
              const cercaRuta = estaSobreRuta(userLatLng, direction === 'sur' ? rutaIda : rutaVuelta);
              if (cercaRuta) {
                const origen = L.latLng(lat, lon);
                mostrarETA(origen, userLatLng, "üß≠ ETA a tu ubicaci√≥n");
              }
            }
          }

          previousPosition = [lat, lon];
          console.log(`Ubicaci√≥n actualizada: ${lat}, ${lon}`);
        }
      } catch (err) {
        console.error('Error al procesar el mensaje MQTT:', err);
      }
    });
  </script
</body>
</html>

